<plan>
  <metadata>
    <feature>Flexible Docs</feature>
    <created>2026-02-16</created>
  </metadata>

  <contract>
    <preconditions>
      <condition id="pre-1">
        <description>Current test suite passes</description>
        <verify>bun test</verify>
      </condition>
      <condition id="pre-2">
        <description>TypeScript compiles cleanly</description>
        <verify>bun run build</verify>
      </condition>
    </preconditions>

    <invariants>
      <invariant critical="true">
        <description>TypeScript compiles without errors throughout</description>
        <verify>bun run build</verify>
      </invariant>
    </invariants>

    <postconditions>
      <condition id="post-1">
        <description>All tests pass including new flexible docs tests</description>
        <verify>bun test</verify>
      </condition>
      <condition id="post-2">
        <description>varp.yaml uses new flexible docs format and parses successfully</description>
        <verify>node -e "const {parseManifest} = require('./build/manifest/parser.js'); const m = parseManifest('./varp.yaml'); const docs = Object.values(m.components)[0].docs; if (!Array.isArray(docs)) throw new Error('docs should be array'); if (!docs[0].load_on) throw new Error('missing load_on');"</verify>
      </condition>
      <condition id="post-3">
        <description>Manifest supports project-level docs field</description>
        <verify>node -e "const {ManifestSchema} = require('./build/types.js'); ManifestSchema.parse({varp:'0.1.0',name:'test',docs:{readme:{path:'./README.md',load_on:['reads']}},components:{}});"</verify>
      </condition>
      <condition id="post-4">
        <description>Resolver uses load_on tags to determine which docs to return</description>
        <verify>bun test src/manifest/resolver.test.ts</verify>
      </condition>
      <condition id="post-5">
        <description>Freshness report covers all arbitrary docs per component</description>
        <verify>bun test src/manifest/freshness.test.ts</verify>
      </condition>
    </postconditions>
  </contract>

  <tasks>
    <task id="1">
      <description>Rewrite docs schema, parser, resolver, and freshness checker for flexible docs.

Schema changes (types.ts):
- ComponentDocsSchema: from { interface: string, internal: string } to array of { name: string, path: string, load_on: ["reads"] | ["writes"] | ["reads", "writes"] }
- ManifestSchema: add optional top-level docs field (same array format, not component-scoped)
- ResolvedDocsSchema: from { interface_docs, internal_docs } to flat array of { component: string, doc_name: string, path: string }
- ComponentFreshnessSchema: from { interface_doc, internal_doc, source_last_modified } to { docs: Record&lt;string, DocFreshness&gt;, source_last_modified: string }
- FreshnessReportSchema: add optional project_docs field for top-level doc freshness

Parser changes (manifest/parser.ts):
- Resolve paths for each doc in the array (not just two hardcoded fields)
- Resolve top-level docs paths too

Resolver changes (manifest/resolver.ts):
- resolveDocs() iterates component docs, checks load_on tag against read/write context
- A doc with load_on: ["reads"] loads when the component is in reads OR writes
- A doc with load_on: ["writes"] loads only when the component is in writes
- A doc with load_on: ["reads", "writes"] loads for either (same as ["reads"])

Freshness changes (manifest/freshness.ts):
- checkFreshness() iterates all docs per component (not just interface/internal)
- Reports freshness for project-level docs too (compared against overall project source mtime)

MCP wiring (index.ts):
- Update varp_resolve_docs handler return shape
- Update varp_check_freshness handler return shape</description>
      <action>implement</action>
      <values>correctness, simplicity, backwards-compatibility-of-behavior</values>
      <touches writes="core" reads="core" />
      <budget tokens="30000" minutes="15" />
    </task>

    <task id="2">
      <description>Update all existing tests and add new test coverage for flexible docs.

- Update manifest parser tests for new docs array format
- Update resolver tests: test load_on: ["reads"], ["writes"], ["reads", "writes"]
- Update freshness tests for arbitrary docs per component
- Add tests for project-level docs (parsing, freshness)
- Update MCP integration tests in index.test.ts for new response shapes
- Update any test fixtures (varp.yaml files) to use new format</description>
      <action>test</action>
      <values>coverage, correctness</values>
      <touches writes="core" reads="core" />
      <budget tokens="25000" minutes="12" />
    </task>

    <task id="3">
      <description>Update interface.md and internal.md to reflect new flexible docs schema.

interface.md:
- Update Component type definition (docs as array with load_on)
- Update Manifest type (add optional top-level docs)
- Update ResolvedDocs type (flat array instead of interface/internal split)
- Update FreshnessReport type (docs as record, project_docs field)
- Update varp_resolve_docs description (load_on semantics)
- Update varp_check_freshness description (arbitrary docs)

internal.md:
- Update data flow diagram
- Note the load_on resolution logic in resolver
- Update freshness description</description>
      <action>document</action>
      <values>accuracy, conciseness</values>
      <touches writes="core" reads="core" />
      <budget tokens="10000" minutes="5" />
    </task>
  </tasks>
</plan>
